import{r as h,u as F,k as R,l as w,j as e}from"./react-Ca1zXMzc.js";import{u as G}from"./@react-router-BZRjp0K8.js";import{ac as v,ad as q,y as x,M as C,B as k,al as Q,Q as b,_,am as D,an as U,ao as V,ap as Y,aq as A,ar as H,Z as K,F as S,a0 as B,z as $,as as Z,at as J,ab as L,a4 as X,au as ee,av as se,aw as te,ag as O,ax as W,a6 as ae}from"./ant-CyvCKrkg.js";import{F as y}from"./vendor-ycCBsJ12.js";import{u as P}from"./index-BMDJZS7J.js";import{u as ne}from"./@uidotdev/usehooks-DljxPWvx.js";import"./recharts--q3ctC58.js";var m=(s=>(s.active="active",s.completed="completed",s.new="new",s))(m||{});const ie=()=>{const{user:s}=P(),[i,a]=h.useState(),n=h.useMemo(()=>(s==null?void 0:s.id)||"",[s==null?void 0:s.id]),{data:t,isLoading:o}=F({...v.getTaskTypes(),refetchOnWindowFocus:!1,refetchOnMount:!1}),{data:u=[],isLoading:r}=F({...v.getUserTasks(n),refetchIntervalInBackground:!0,refetchInterval:5*q,refetchOnWindowFocus:!1,enabled:!!n});return h.useEffect(()=>{if(!(t!=null&&t.length))return;const p={};t.forEach(l=>{p[l.id]||(p[l.id]={data:[],stats:{all:0,inWork:0},label:l.title})}),u.forEach(l=>{p[l.type_id].data.push(l),p[l.type_id].stats.all+=1,l.status_id===m.active&&(p[l.type_id].stats.inWork+=1)}),a(p)},[u,t]),{taskTypesIsLoading:o,taskTypes:t,userTasks:u,userTasksIsLoading:r,taskGroups:i,userId:n}},ce=(s,i)=>{const[a,n]=h.useState(s.text),t=ne(a,300);return h.useEffect(()=>{t!==s.text&&i({...s,text:t})},[t,i,s]),{value:a,setValue:n}},oe=({task:s})=>{const{done:i,priority:a=0}=s,n=R(),{user:t}=P(),o=w({mutationFn:v.deleteTask,onSuccess:c=>{n.setQueryData([b.tasks,t.id],j=>j==null?void 0:j.filter(I=>I.id!==c))}}),u=w({mutationFn:v.updateTask,onSuccess:c=>{n.setQueryData([b.tasks,t.id],j=>{const I=[...j??[]],E=I.findIndex(z=>z.id===c.id);return E!==-1&&(I[E]={...I[E],...c}),[...I]})}}),r=()=>{o.mutate(s.id,{onError:c=>{_.error(c.message)}})},p=c=>{u.mutate(c)},l=()=>{p({...s,done:!s.done})},g=()=>{p({...s,status_id:s.status_id===m.active?m.new:m.active,done:!1})},{value:T,setValue:d}=ce(s,p),f=o.isPending||u.isPending,N=()=>{switch(s.status_id){case m.active:return e.jsx(C,{className:y("task-input",!!a&&`task-input--prioriry-${a}`,{"task-input--done":!!i,"task-input--has-prioriry ":!!a}),value:T,disabled:f,onChange:c=>{d(c.target.value)},prefix:e.jsx(k,{icon:e.jsx(V,{className:y("task-icon-check-online",i&&"task-icon-check-online--checked")}),type:"text",onClick:l}),suffix:e.jsxs(x,{className:"task-input-actions",justify:"end",children:[e.jsx(k,{icon:e.jsx(Y,{}),type:"text"}),e.jsx(k,{icon:e.jsx(A,{}),type:"text"}),e.jsx(k,{icon:e.jsx(Q,{}),type:"text"}),e.jsx(k,{icon:e.jsx(H,{}),onClick:g,type:"text"}),e.jsx(k,{disabled:o.isPending,className:"action-delete",icon:e.jsx(K,{}),onClick:r,type:"text"})]})});case m.new:return e.jsx(C,{className:"task-input",value:T,onChange:c=>{d(c.target.value)},prefix:e.jsx(k,{icon:e.jsx(D,{}),onClick:g,type:"text"}),suffix:e.jsx(k,{icon:e.jsx(U,{}),onClick:r,type:"text"})})}};return e.jsx(x,{justify:"space-between",align:"center",gap:16,children:N()})},re=({text:s,author_id:i,type_id:a})=>{const n=R(),t=w({mutationFn:v.createTask}),o=()=>{t.mutate({authorId:i,task:s,taskStatus:m.new,typeId:a},{onSuccess:async()=>{await n.invalidateQueries({queryKey:[b.tasks,i]}),_.success("Задача добавлена в 'Запланированные' ")}})};return e.jsx(x,{justify:"space-between",align:"center",gap:16,className:"task-completed-row",children:e.jsx(C,{className:"task-input",value:s,readOnly:!0,suffix:e.jsx(k,{onClick:o,icon:e.jsx(Q,{}),shape:"circle",type:"text",loading:t.isPending})})})},M=({title:s,total:i=0,complite:a=0,tasks:n,taskStatus:t,typeId:o})=>{const[u,r]=h.useState(!1),p=R(),[l]=S.useForm(),{user:g}=P(),{mutate:T,isPending:d}=w({mutationFn:async c=>await v.createTask(c),onSuccess(c){p.setQueryData([b.tasks,g.id],j=>[...j,c])}}),f=t===m.active,N=({task:c})=>{T({task:c,taskStatus:t,typeId:o,authorId:g.id},{onError:j=>{_.error(j.name)},onSuccess:async()=>{l.resetFields()}})};return e.jsxs(x,{vertical:!0,className:y({"task-field-wrapper":!0,"task-field-wrapper--active":f}),children:[e.jsx(B,{count:a?`${a}/${i}`:i,offset:[20,12],className:y({"task-field-badge":!0,"task-field-badge--active":f}),children:e.jsxs($.Text,{type:"secondary",children:[s,":"]})}),e.jsx(S,{onFinish:N,form:l,className:"task-field-form",children:e.jsx(S.Item,{noStyle:!0,name:"task",children:e.jsx(x,{onClick:()=>r(!0),onBlur:()=>r(!1),children:e.jsx(C,{disabled:d,className:y("task-input","task-input-create",f&&"task-input-create--active"),placeholder:u?"":"Создать задачу",prefix:u?e.jsx(Z,{style:{fontSize:16}}):e.jsx(J,{})})})})}),e.jsx("div",{className:"task-field-content",children:n.map(c=>e.jsx(oe,{task:c},c.id))})]})},le=({active:s=!1,tasks:i=[],type:a,userId:n})=>{const[t,o]=h.useState(!1),{data:u=[],isFetching:r}=F({...v.getUserCompletedTasks(n,a),enabled:t});if(h.useEffect(()=>{!s&&t&&o(!1)},[s,t]),!s||!a)return;const p=L[a],{activeTasks:l=[],newTasks:g=[]}=i.reduce((d,f)=>(f.status_id==="new"&&d.newTasks.push(f),f.status_id==="active"&&d.activeTasks.push(f),d),{newTasks:[],activeTasks:[]}),T=l.filter(({done:d})=>d).length;return e.jsxs(x,{className:"task-type-panel",vertical:!0,align:"start",gap:8,children:[e.jsxs(x,{className:"task-type-panel__content",vertical:!0,flex:1,children:[e.jsx(M,{title:"В работе",complite:T,total:l.length,taskStatus:m.active,tasks:l,typeId:a}),e.jsx(M,{title:"Запланированы",total:g.length,taskStatus:m.new,tasks:g,typeId:a})]}),e.jsxs(x,{className:"task-type-panel__float-buttons",vertical:!0,gap:4,children:[p&&e.jsx(X,{content:e.jsx("div",{style:{width:500},children:p.info}),title:"Разяснение в помощь о текуших задач",children:e.jsx(k,{icon:e.jsx(ee,{size:24}),size:"small",type:"text",shape:"circle"})}),e.jsx(k,{icon:e.jsx(se,{}),title:"Показать выполненные",size:"small",type:"text",shape:"circle",onClick:d=>{d.stopPropagation(),o(!0)}})]}),e.jsx(te,{title:e.jsxs(e.Fragment,{children:[e.jsx($.Text,{type:"secondary",children:" Звершенные задачи : "}),e.jsx(B,{count:u.length,color:"cyan"})]}),placement:"right",onClose:d=>{d.stopPropagation(),o(!1)},open:t,getContainer:!1,styles:{mask:{background:"none"},header:{padding:"0.5rem 1rem"},body:{padding:"0.5rem 1rem"}},children:e.jsx(x,{vertical:!0,gap:16,children:e.jsx(O,{spinning:r,children:[...u,...u].map((d,f)=>h.createElement(re,{...d,key:f}))})})})]})},ue=({stats:s,onClick:i,active:a=!1,id:n,title:t})=>{const o=L[n].icon||null;return e.jsxs(x,{className:y({"task-type-container":!0,"task-type-container--active":a}),vertical:!0,justify:"space-between",onClick:u=>{u.stopPropagation(),i==null||i(n)},children:[e.jsx($.Title,{level:3,children:t}),e.jsxs(x,{justify:"space-between",children:[e.jsxs(x,{vertical:!0,children:[e.jsxs("span",{children:["Текущие: ",s.inWork]}),e.jsxs("span",{children:["Всего: ",s.all]})]}),o&&e.jsx(o,{style:{fontSize:32}})]})]})},{Content:de,Sider:pe}=W,ye=()=>{const[s,i]=h.useState(null),a=G(),{taskGroups:n,userTasksIsLoading:t,userId:o}=ie(),u=r=>{i(s===r?null:r)};return e.jsxs(W,{className:"tasks-page-layout",children:[e.jsx(de,{className:"task-page-content",onClick:()=>{i(null)},children:e.jsx(O,{spinning:t,children:e.jsx(x,{className:"task-page-container",children:n&&Object.keys(n).map(r=>e.jsx(ue,{active:s===r,title:n[r].label,id:r,onClick:u,stats:n[r].stats},r))})})}),e.jsx(pe,{className:y("tasks-page-sider ",!s&&"tasks-page-sider--collapsed"),trigger:null,collapsed:!s,collapsible:!0,defaultCollapsed:!0,collapsedWidth:0,width:"60%",children:e.jsx(le,{tasks:s?n[s].data:[],active:!!s,type:s,closeForm:()=>a(ae.BASE),userId:o},s)})]})};export{ye as TasksPage};
